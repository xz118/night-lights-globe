<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Economic Night Lights Explorer</title>
    
    <!-- Three.js & Controls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@300;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary: #00F0FF;
            --accent: #FFD700;
            --glass: rgba(11, 18, 33, 0.75);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: #000;
            color: #E0E6ED;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Fullscreen app feeling */
            width: 100vw;
            height: 100vh;
        }

        /* --- 3D CANVAS --- */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: radial-gradient(circle at center, #0b1026 0%, #000 100%);
        }

        /* Loading Screen */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        .loading-bar-container {
            width: 200px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            margin-top: 20px;
            overflow: hidden;
        }
        .loading-bar {
            width: 0%;
            height: 100%;
            background: var(--primary);
            transition: width 0.2s;
        }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to globe where no UI exists */
            opacity: 0; /* Hidden until loaded */
            transition: opacity 0.5s ease;
        }

        /* 1. HEADER */
        .app-header {
            position: absolute;
            top: 30px;
            left: 30px;
            pointer-events: auto;
        }
        .app-header h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 32px;
            color: #fff;
            text-shadow: 0 0 20px rgba(0, 240, 255, 0.5);
        }
        .app-header p {
            color: var(--primary);
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* 2. STORY SIDEBAR (LEFT) */
        .story-panel {
            position: absolute;
            top: 120px;
            left: 30px;
            width: 350px;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-right: 10px;
        }

        .chapter-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .chapter-card:hover, .chapter-card.active {
            border-color: var(--primary);
            background: rgba(11, 18, 33, 0.9);
            transform: translateX(5px);
        }

        .chapter-card.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--primary);
        }

        .chapter-title {
            font-family: 'Space Grotesk', sans-serif;
            color: #fff;
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .chapter-content {
            font-size: 14px;
            color: #94A3B8;
            line-height: 1.5;
            display: none; /* Hidden by default */
        }
        
        .chapter-card.active .chapter-content {
            display: block;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .chapter-img {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        .chapter-card.active .chapter-img { display: block; }

        /* 3. AI TOOLS (RIGHT) */
        .tools-panel {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 320px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .tool-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .tool-header {
            color: var(--accent);
            font-family: 'Space Grotesk', sans-serif;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-input {
            width: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: 'Inter', sans-serif;
        }

        .ai-btn {
            width: 100%;
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ai-btn:hover { background: #00c2ce; }

        .ai-result {
            margin-top: 15px;
            font-size: 13px;
            line-height: 1.4;
            color: #E0E6ED;
            max-height: 200px;
            overflow-y: auto;
            border-left: 2px solid var(--accent);
            padding-left: 10px;
        }

        /* CHAT WIDGET (Bottom Right) */
        .chat-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #000;
            font-size: 20px;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.4);
            z-index: 20;
            pointer-events: auto;
        }
        
        .chat-window {
            position: fixed;
            bottom: 90px;
            right: 30px;
            width: 320px;
            height: 400px;
            background: rgba(11, 18, 33, 0.95);
            border: 1px solid var(--primary);
            border-radius: 12px;
            z-index: 20;
            display: none;
            flex-direction: column;
            pointer-events: auto;
        }
        
        /* Loading Animation */
        .loader {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Markdown overrides */
        .markdown-body p { margin-bottom: 5px; }
        .markdown-body strong { color: var(--primary); }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loading-screen">
        <h2 style="font-family:'Space Grotesk'; color:#fff;">Loading Earth Data...</h2>
        <div class="loading-bar-container">
            <div id="loading-bar" class="loading-bar"></div>
        </div>
    </div>

    <!-- 3D SCENE CONTAINER -->
    <div id="canvas-container"></div>

    <!-- UI OVERLAY -->
    <div id="ui-layer">
        
        <!-- HEADER -->
        <div class="app-header">
            <h1>Night Lights</h1>
            <p>Economic Proxy Explorer</p>
        </div>

        <!-- LEFT: STORYTELLING -->
        <div class="story-panel">
            <!-- Chapter 1 -->
            <div class="chapter-card active" onclick="activateChapter(0)">
                <div class="chapter-title">
                    <span>01. Definition</span>
                    <i class="fa-solid fa-lightbulb"></i>
                </div>
                <div class="chapter-content">
                    <p>Nighttime Lights (NTL) data captures all artificial light visible from space, serving as a <strong>digital footprint</strong> of human presence.</p>
                    <img src="https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=600" class="chapter-img" alt="City Lights">
                </div>
            </div>

            <!-- Chapter 2 -->
            <div class="chapter-card" onclick="activateChapter(1)">
                <div class="chapter-title">
                    <span>02. Observation</span>
                    <i class="fa-solid fa-satellite"></i>
                </div>
                <div class="chapter-content">
                    <p>From the blurry <strong>DMSP</strong> satellites of the 90s to the sharp, calibrated <strong>VIIRS</strong> sensors today, our ability to monitor the economy from space has evolved dramatically.</p>
                </div>
            </div>

            <!-- Chapter 3 -->
            <div class="chapter-card" onclick="activateChapter(2)">
                <div class="chapter-title">
                    <span>03. Economic Logic</span>
                    <i class="fa-solid fa-chart-line"></i>
                </div>
                <div class="chapter-content">
                    <p><strong>Henderson et al. (2012)</strong>: As income rises, demand for light increases. Brightness correlates strongly with GDP, helping us estimate growth in data-poor regions.</p>
                </div>
            </div>

            <!-- Chapter 4 -->
            <div class="chapter-card" onclick="activateChapter(3)">
                <div class="chapter-title">
                    <span>04. Limitations</span>
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <div class="chapter-content">
                    <p>While great for cross-sectional comparison (Rich vs Poor), NTL is less accurate for tracking small yearly growth. Also, <strong>agriculture is "dark"</strong>â€”farms produce money but not much light.</p>
                </div>
            </div>
        </div>

        <!-- RIGHT: AI TOOLS -->
        <div class="tools-panel">
            <div class="tool-card">
                <div class="tool-header">
                    <i class="fa-solid fa-earth-americas"></i> Region Analyzer
                </div>
                <p style="font-size: 12px; color: #94A3B8; margin-bottom: 8px;">Analyze economic signals from space.</p>
                <input type="text" id="regionInput" class="ai-input" placeholder="e.g., North Korea vs South Korea">
                <button class="ai-btn" onclick="analyzeRegion()">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Analyze
                </button>
                <div id="analysisResult" class="ai-result"></div>
            </div>
        </div>

        <!-- CHAT BOT -->
        <div class="chat-toggle" onclick="toggleChat()">
            <i class="fa-solid fa-comments"></i>
        </div>
        <div class="chat-window" id="chatWindow" style="display: none;">
            <div style="padding: 15px; border-bottom: 1px solid #333; background: rgba(0,240,255,0.1);">
                <strong style="color:var(--primary)">Ask the Economist</strong>
            </div>
            <div id="chatMessages" style="flex:1; overflow-y:auto; padding:15px; font-size:13px; color:#ccc;">
                <p>Hello! I can explain the economic implications of nighttime lights.</p>
            </div>
            <div style="padding:10px; border-top:1px solid #333; display:flex;">
                <input type="text" id="chatInput" class="ai-input" style="margin-bottom:0; border-radius: 4px 0 0 4px;" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="ai-btn" style="width:auto; border-radius: 0 4px 4px 0;" onclick="sendChat()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

    </div>

    <script>
        /* --- CONFIGURATION --- */
        const apiKey = ""; // Environment Key
        let scene, camera, renderer, controls, earth, stars;

        /* --- 1. THREE.JS HD GLOBE SETUP --- */
        function init3D() {
            const container = document.getElementById('canvas-container');
            
            // Scene
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.0005);

            // Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 2.5;

            // Renderer (High Performance)
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.outputEncoding = THREE.sRGBEncoding;
            container.appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;
            controls.minDistance = 1.2; 
            controls.maxDistance = 5;

            // --- CREATING THE UNIVERSE ---

            // 1. Starfield
            const starGeo = new THREE.BufferGeometry();
            const starCount = 3000;
            const posArray = new Float32Array(starCount * 3);
            for(let i=0; i<starCount*3; i++) {
                posArray[i] = (Math.random() - 0.5) * 30; 
            }
            starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const starMat = new THREE.PointsMaterial({
                size: 0.015,
                color: 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            stars = new THREE.Points(starGeo, starMat);
            scene.add(stars);

            // 2. Earth Group
            const earthGroup = new THREE.Group();
            scene.add(earthGroup);

            // 3. Atmosphere Glow
            const vertexShader = `
                varying vec3 vNormal;
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;
            const fragmentShader = `
                varying vec3 vNormal;
                void main() {
                    float intensity = pow(0.6 - dot(vNormal, vec3(0, 0, 1.0)), 4.5);
                    gl_FragColor = vec4(0.0, 0.6, 1.0, 1.0) * intensity * 1.5;
                }
            `;
            const atmoGeo = new THREE.SphereGeometry(1.05, 64, 64);
            const atmoMat = new THREE.ShaderMaterial({
                vertexShader: vertexShader,
                fragmentShader: fragmentShader,
                blending: THREE.AdditiveBlending,
                side: THREE.BackSide,
                transparent: true
            });
            const atmosphere = new THREE.Mesh(atmoGeo, atmoMat);
            earthGroup.add(atmosphere);

            // 4. High Definition Earth (2K Stable + Bump Map)
            const earthGeo = new THREE.SphereGeometry(1, 128, 128); 
            const textureLoader = new THREE.TextureLoader();
            textureLoader.setCrossOrigin('anonymous');
            
            // Loading Manager
            const loadingManager = new THREE.LoadingManager();
            loadingManager.onProgress = function(url, itemsLoaded, itemsTotal) {
                const progress = (itemsLoaded / itemsTotal) * 100;
                document.getElementById('loading-bar').style.width = progress + '%';
            };
            loadingManager.onLoad = function() {
                const screen = document.getElementById('loading-screen');
                const ui = document.getElementById('ui-layer');
                screen.style.opacity = 0;
                setTimeout(() => screen.remove(), 500);
                ui.style.opacity = 1; 
            };

            const texLoader = new THREE.TextureLoader(loadingManager);
            
            // URL CHANGE: Use 2048px (Stable HD) instead of 4096px
            const texUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/The_earth_at_night.jpg/2048px-The_earth_at_night.jpg'; 
            const bumpUrl = 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/Topography_of_earth.jpg/1024px-Topography_of_earth.jpg';

            // Load Base Texture FIRST
            texLoader.load(texUrl, (texture) => {
                texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                
                // Try Loading Bump Map
                texLoader.load(bumpUrl, (bumpTex) => {
                    // Success: Create Material with Bump
                    createEarthMesh(texture, bumpTex);
                }, undefined, (err) => {
                    console.warn("Bump map failed, loading standard mesh");
                    // Failure: Create Material without Bump
                    createEarthMesh(texture, null);
                });

            }, undefined, (err) => {
                console.error("Base texture failed", err);
                // Ultimate Fallback
                const fallbackMat = new THREE.MeshBasicMaterial({ color: 0x001133, wireframe: true });
                earth = new THREE.Mesh(earthGeo, fallbackMat);
                earthGroup.add(earth);
            });

            function createEarthMesh(map, bumpMap) {
                const earthMat = new THREE.MeshStandardMaterial({
                    map: map,
                    bumpMap: bumpMap,
                    bumpScale: 0.02,
                    roughness: 0.8,
                    metalness: 0.1,
                    color: 0xffffff 
                });
                earth = new THREE.Mesh(earthGeo, earthMat);
                earthGroup.add(earth);
                
                // Lighting for Bump Map
                const sunLight = new THREE.DirectionalLight(0xffffff, 1);
                sunLight.position.set(5, 3, 5);
                scene.add(sunLight);
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.2);
                scene.add(ambientLight);
            }

            // Animation Loop
            const animate = function () {
                requestAnimationFrame(animate);
                controls.update();
                stars.rotation.y -= 0.0001;
                renderer.render(scene, camera);
            };
            animate();

            // Resize Handle
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        /* --- 2. UI LOGIC --- */
        function activateChapter(index) {
            const cards = document.querySelectorAll('.chapter-card');
            cards.forEach((c, i) => {
                if (i === index) c.classList.add('active');
                else c.classList.remove('active');
            });

            if (!controls) return;
            
            switch(index) {
                case 0: 
                    controls.autoRotateSpeed = 0.5;
                    break;
                case 1: 
                    controls.autoRotateSpeed = 2.0; 
                    break;
                case 2: 
                    controls.autoRotateSpeed = 0.2;
                    break;
                case 3: 
                    controls.autoRotateSpeed = -0.5; 
                    break;
            }
        }

        /* --- 3. AI LOGIC (GEMINI) --- */
        async function callGemini(prompt) {
            if (!apiKey) return "Error: API Key is missing.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error";
            } catch (e) { return "Connection Error"; }
        }

        async function analyzeRegion() {
            const input = document.getElementById('regionInput').value;
            const output = document.getElementById('analysisResult');
            if(!input) return;

            output.innerHTML = '<div class="loader"></div> Analyzing spectrum...';
            const prompt = `You are a satellite imagery expert. Analyze the economic implications of nighttime lights for: "${input}". Keep it short (max 50 words), technical but clear.`;
            
            const text = await callGemini(prompt);
            output.innerHTML = marked.parse(text);
        }

        function toggleChat() {
            const win = document.getElementById('chatWindow');
            win.style.display = win.style.display === 'none' ? 'flex' : 'none';
        }

        async function sendChat() {
            const input = document.getElementById('chatInput');
            const box = document.getElementById('chatMessages');
            const text = input.value;
            if(!text) return;

            // User Msg
            box.innerHTML += `<p style="color:#fff; margin-top:10px;"><strong>You:</strong> ${text}</p>`;
            input.value = '';
            box.scrollTop = box.scrollHeight;

            // AI Msg
            box.innerHTML += `<p id="loadingTemp" style="color:var(--primary); margin-top:5px;">Typing...</p>`;
            const prompt = `Context: Economic analysis using Nighttime Lights (NTL) data. User Question: ${text}. Answer briefly.`;
            const response = await callGemini(prompt);
            
            document.getElementById('loadingTemp').remove();
            box.innerHTML += `<div class="markdown-body" style="color:#ccc; margin-top:5px;">${marked.parse(response)}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // Start
        window.onload = init3D;

    </script>
</body>
</html>